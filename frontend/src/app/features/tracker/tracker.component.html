<div class="tracker">
  <!-- Player Section -->
  <mat-card class="player-card">
    <mat-card-content>
      <div class="player-section">
        <div class="player-avatar">
          <mat-icon class="player-avatar__icon">account_circle</mat-icon>
        </div>
        <div class="player-info">
          <mat-form-field appearance="outline" class="player-name-field">
            <mat-label>Your Name</mat-label>
            <input
              matInput
              type="text"
              [value]="playerName()"
              (blur)="updatePlayerName($any($event.target).value)"
              placeholder="Enter your name"
            />
          </mat-form-field>
          <div class="player-stats">
            <mat-chip class="stat-chip stat-chip--wins">
              <mat-icon>celebration</mat-icon>
              {{ totalWins() }} Wins
            </mat-chip>
            <mat-chip class="stat-chip stat-chip--losses">
              <mat-icon>sentiment_dissatisfied</mat-icon>
              {{ totalLosses() }} Losses
            </mat-chip>
            <mat-chip class="stat-chip stat-chip--kills">
              <mat-icon>military_tech</mat-icon>
              {{ totalKills() }} Eliminations
            </mat-chip>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Header with current match info -->
  <div class="tracker__header">
    <h2 class="tracker__title">
      @if (currentMatchNumber() <= 7) {
        Recording Phase - Match {{ currentMatchNumber() }} of 7
      } @else {
        Match {{ currentMatchNumber() }}
      }
    </h2>
    @if (currentMatchNumber() > 7 && predictedOpponent(); as opponent) {
      <div class="tracker__prediction">
        <mat-icon class="tracker__prediction-icon">psychology</mat-icon>
        <span class="tracker__prediction-text">
          Predicted opponent: <strong>{{ opponent.name }}</strong>
        </span>
      </div>
    }
  </div>

  <!-- Input Section (only show until 7 opponents recorded) -->
  @if (showOpponentInput()) {
    <mat-card class="tracker__input-card">
      <mat-card-content>
        <div class="tracker__input-section">
          <mat-form-field appearance="outline" class="tracker__input-field">
            <mat-label>Opponent Name for Match {{ currentMatchNumber() }}</mat-label>
            <input
              matInput
              type="text"
              [value]="opponentName()"
              (input)="onInputChange($any($event.target).value)"
              (keydown.enter)="addOpponent()"
              [matAutocomplete]="auto"
              placeholder="Enter opponent name"
              [attr.aria-label]="'Enter opponent name for match ' + currentMatchNumber()"
            />
            <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onAutocompleteSelected($event.option.value)">
              @for (suggestion of suggestions(); track suggestion) {
                <mat-option [value]="suggestion">{{ suggestion }}</mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
          
          <button
            mat-raised-button
            color="primary"
            (click)="addOpponent()"
            [disabled]="!canAddOpponent()"
            class="tracker__add-button"
            aria-label="Add opponent"
          >
            <mat-icon>add</mat-icon>
            Add Enemy
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  }

  <!-- Next Match Actions -->
  @if (opponents().length > 0) {
    <div class="tracker__actions">
      <mat-card class="tracker__actions-card">
        <mat-card-content>
          @if (showOpponentInput()) {
            <p class="tracker__actions-hint">
              After adding all 7 enemies, use "Next Match" to advance and track eliminations.
            </p>
          }
          
          @if (pendingElimination()) {
            <div class="tracker__elimination-prompt">
              <mat-icon class="tracker__elimination-icon">help</mat-icon>
              <p>Did <strong>{{ getOpponentById(pendingElimination()!)?.name }}</strong> get eliminated this match?</p>
              <div class="tracker__elimination-actions">
                <button
                  mat-raised-button
                  color="warn"
                  (click)="confirmElimination(true)"
                  class="tracker__elimination-button"
                >
                  <mat-icon>cancel</mat-icon>
                  Yes, Eliminated
                </button>
                <button
                  mat-raised-button
                  color="primary"
                  (click)="confirmElimination(false)"
                  class="tracker__elimination-button"
                >
                  <mat-icon>check_circle</mat-icon>
                  No, Still Alive
                </button>
              </div>
            </div>
          } @else {
            <button
              mat-raised-button
              color="accent"
              (click)="nextMatch()"
              [disabled]="!canAdvanceMatch()"
              class="tracker__next-match-button"
            >
              <mat-icon>skip_next</mat-icon>
              Next Match
            </button>
          }
        </mat-card-content>
      </mat-card>
    </div>
  }

  <!-- Opponents Grid -->
  <div class="tracker__opponents-section">
    <h3 class="tracker__opponents-title">Enemies ({{ aliveOpponentsCount() }}/{{ opponents().length }} alive)</h3>
    
    @if (opponents().length === 0) {
      <div class="tracker__empty-state">
        <mat-icon class="tracker__empty-icon">person_add</mat-icon>
        <p>No enemies recorded yet. Start by adding your first opponent above.</p>
      </div>
    } @else {
      <div class="tracker__opponents-grid" style="display: flex; flex-flow: row wrap; gap: 8px; justify-content: flex-start; align-items: flex-start;">
        @for (opponent of opponents(); track opponent.id; let index = $index) {
          <mat-card 
            class="opponent-box" 
            [class.opponent-box--dead]="opponent.isDead"
            [class.opponent-box--pending-elimination]="pendingElimination() === opponent.id"
            [style.width.px]="150"
            [style.maxWidth.px]="150"
            [style.minWidth.px]="150"
            [style.flex]="'0 0 150px'"
          >
            <mat-card-header class="opponent-box__header">
              <div class="opponent-box__match-number">Match {{ index + 1 }}</div>
            </mat-card-header>
            <mat-card-content class="opponent-box__content">
              <mat-icon 
                class="opponent-box__avatar-icon"
                [style.color]="opponent.color || '#6200ea'"
              >
                {{ opponent.icon || 'account_circle' }}
              </mat-icon>
              <div class="opponent-box__name">{{ opponent.name }}</div>
              
              @if (getRecentMatchHistory(opponent).length > 0) {
                <div class="opponent-box__history">
                  @for (result of getRecentMatchHistory(opponent); track result.matchNumber) {
                    <div 
                      class="opponent-box__history-badge"
                      [class.opponent-box__history-badge--win]="result.outcome === 'win'"
                      [class.opponent-box__history-badge--loss]="result.outcome === 'loss'"
                    >
                      {{ result.outcome === 'win' ? 'W' : 'L' }}
                    </div>
                  }
                </div>
              }
            </mat-card-content>
          </mat-card>
        }
      </div>
    }
  </div>
</div>
